#!/bin/bash
set -euo pipefail

TOKEN="${PAT_GITHUB_DISPATCH:-}"

event_type="${1:?An event type (fetch-and-ingest, ingest, rebuild, or update-image) is required as the first argument.}"
shift

if [[ $# -eq 0 && -z $TOKEN ]]; then
    cat >&2 <<.
You must specify options to curl for your GitHub credentials.  For example, you
can specify your GitHub username, and will be prompted for your password:

  $0 $event_type --user <your-github-username>

Be sure to enter a personal access token¹ as your password since GitHub has
discontinued password authentication to the API starting on November 13, 2020².

You can also store your credentials or a personal access token in a netrc
file³:

  machine api.github.com
  login <your-username>
  password <your-token>

and then tell curl to use it:

  $0 $event_type --netrc

which will then not require you to type your password every time.

¹ https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line
² https://docs.github.com/en/rest/overview/other-authentication-methods#via-username-and-password
³ https://ec.haxx.se/usingcurl/usingcurl-netrc
.
    exit 1
fi

auth=':'
if [[ $TOKEN ]]; then
  auth="Authorization: Bearer ${TOKEN}"
fi

if curl -fsS https://api.github.com/repos/nextstrain/ncov-ingest/dispatches \
    -H 'Accept: application/vnd.github.v3+json' \
    -H 'Content-Type: application/json' \
    -H "$auth" \
    -d '{"event_type":"'"$event_type"'"}' \
    "$@"
then
    echo "Successfully triggered $event_type"
else
    echo "Request failed" >&2
    exit 1
fi
