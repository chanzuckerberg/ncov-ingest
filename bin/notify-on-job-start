#!/bin/bash
set -euo pipefail

: "${SLACK_TOKEN:?The SLACK_TOKEN environment variable is required.}"
: "${SLACK_CHANNELS:?The SLACK_CHANNELS environment variable is required.}"

bin="$(dirname "$0")"

JOB_NAME="${1:?Job name is required as the first argument.}"

if [ -n "${AWS_BATCH_JOB_ID}" ]; then
    echo "Notifying Slack about started AWS Batch job. AWS_BATCH_JOB_ID=\"${AWS_BATCH_JOB_ID}\"."

    msg_job_id="${JOB_NAME} from AWS Batch job \`${AWS_BATCH_JOB_ID}\` (<https://console.aws.amazon.com/batch/v2/home?region=us-east-1#jobs/detail/${AWS_BATCH_JOB_ID}|link>) started"

    msg_action="The job was submitted by GitHub Action <https://github.com/nextstrain/ncov-ingest/actions/runs/${GITHUB_RUN_ID}?check_suite_focus=true|${GITHUB_RUN_ID}>"

    msg_command="Follow along in your local \`ncov-ingest\` repo with: "'```'"nextstrain build --aws-batch --attach ${AWS_BATCH_JOB_ID} ."'```'

    "bin"/notify-slack "${msg_job_id}. ${msg_action}. ${msg_command}"
fi
